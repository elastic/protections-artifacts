[rule]
description = """
Detects when a library gets loaded from within the users home directory and the file is not a specified .so or .dylib
file.
"""
id = "d9b30b84-dc53-413c-a7e4-f42078b10048"
license = "Elastic License v2"
name = "Unusual Library Load via Python"
os_list = ["macos"]
reference = [
    "https://unit42.paloaltonetworks.com/slow-pisces-new-custom-malware/",
    "https://slowmist.medium.com/cryptocurrency-apt-intelligence-unveiling-lazarus-groups-intrusion-techniques-a1a6efda7d34",
]
version = "1.0.8"

query = '''
library where event.action == "load" and dll.path like "/Users/*" and process.name like~ "python*" and 
 not dll.name : ("*.so", "*.dylib", "Python", "*.*_extension") and
 not dll.path like~ "*/site-packages/*/Qt*/lib/Qt*.framework/Versions/*/Qt*"
'''

min_endpoint_version = "8.16.0"
optional_actions = []
[[actions]]
action = "kill_process"
field = "process.entity_id"
state = 0

[[threat]]
framework = "MITRE ATT&CK"
[[threat.technique]]
id = "T1059"
name = "Command and Scripting Interpreter"
reference = "https://attack.mitre.org/techniques/T1059/"
[[threat.technique.subtechnique]]
id = "T1059.006"
name = "Python"
reference = "https://attack.mitre.org/techniques/T1059/006/"



[threat.tactic]
id = "TA0002"
name = "Execution"
reference = "https://attack.mitre.org/tactics/TA0002/"

[internal]
min_endpoint_version = "8.16.0"
