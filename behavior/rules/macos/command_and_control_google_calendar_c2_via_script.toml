[rule]
description = """
Detects the two-stage Google Calendar C2 pattern in which a scripting runtime (e.g. Node.js or Python) first reaches out
to calendar.app.google to retrieve a hidden C2 address, then immediately initiates a secondary connection to the decoded
C2 host. This sequence is characteristic of packages that use Unicode steganography in Google Calendar events to stage a
dynamic command-and-control endpoint.
"""
id = "b70c56b7-d340-4fff-a69a-290aeac138d7"
license = "Elastic License v2"
name = "Google Calendar C2 via Script"
os_list = ["macos"]
reference = [
    "https://www.veracode.com/resources/sophisticated-npm-attack-leveraging-unicode-steganography-and-google-calendar-c2",
    "https://www.koi.ai/blog/glassworm-first-self-propagating-worm-using-invisible-code-hits-openvsx-marketplace",
]
version = "1.0.1"

query = '''
sequence by process.entity_id with maxspan=20s
[network where (process.name like~ ("node", "python*", "osascript") or (process.code_signature.exists == false or process.code_signature.trusted == false)) and destination.domain like "calendar.app.google*"]
[network where destination.domain == null]
'''

min_endpoint_version = "8.16.0"
optional_actions = []
[[actions]]
action = "kill_process"
field = "process.entity_id"
state = 0

[[actions]]
action = "kill_process"
field = "process.parent.entity_id"
state = 0

[[threat]]
framework = "MITRE ATT&CK"
[[threat.technique]]
id = "T1059"
name = "Command and Scripting Interpreter"
reference = "https://attack.mitre.org/techniques/T1059/"
[[threat.technique.subtechnique]]
id = "T1059.006"
name = "Python"
reference = "https://attack.mitre.org/techniques/T1059/006/"

[[threat.technique.subtechnique]]
id = "T1059.007"
name = "JavaScript"
reference = "https://attack.mitre.org/techniques/T1059/007/"



[threat.tactic]
id = "TA0002"
name = "Execution"
reference = "https://attack.mitre.org/tactics/TA0002/"
[[threat]]
framework = "MITRE ATT&CK"
[[threat.technique]]
id = "T1102"
name = "Web Service"
reference = "https://attack.mitre.org/techniques/T1102/"
[[threat.technique.subtechnique]]
id = "T1102.002"
name = "Bidirectional Communication"
reference = "https://attack.mitre.org/techniques/T1102/002/"



[threat.tactic]
id = "TA0011"
name = "Command and Control"
reference = "https://attack.mitre.org/tactics/TA0011/"

[internal]
min_endpoint_version = "8.16.0"
