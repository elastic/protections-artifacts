[rule]
description = """
Detects attempts to create custom Windows Firewall rules designed to block network traffic from Elastic Defend
processes. Such activity may indicate an adversaryâ€™s effort to disrupt alerting or telemetry communication with Elastic
servers. This alert is triggered by the Elastic Firewall Anti-Tamper plugin and only occurs when a malicious package
drop is identified.
"""
id = "59a1be31-fffa-49b1-9757-29011141c5e8"
license = "Elastic License v2"
name = "Potential Elastic Endpoint Tampering via Firewall"
os_list = ["windows"]
reference = [
    "https://medium.com/csis-techblog/silencing-microsoft-defender-for-endpoint-using-firewall-rules-3839a8bf8d18",
]
version = "1.0.1"

query = '''
api where process.Ext.api.name == "INetFwRules::Add" and process.Ext.api.summary : ("*elastic-endpoint.exe*", "*elastic-agent.exe*")
'''

actions = []
min_endpoint_version = "9.2.0"
[[optional_actions]]
action = "rollback"
field = "process.entity_id"
state = 0

[[threat]]
framework = "MITRE ATT&CK"
[[threat.technique]]
id = "T1562"
name = "Impair Defenses"
reference = "https://attack.mitre.org/techniques/T1562/"
[[threat.technique.subtechnique]]
id = "T1562.001"
name = "Disable or Modify Tools"
reference = "https://attack.mitre.org/techniques/T1562/001/"



[threat.tactic]
id = "TA0005"
name = "Defense Evasion"
reference = "https://attack.mitre.org/tactics/TA0005/"

[internal]
min_endpoint_version = "9.2.0"
