[rule]
description = """
Detects launchctl loading plist files from non-standard locations outside LaunchAgents/LaunchDaemons directories. This
technique is used by malware to establish persistence while evading detection.
"""
id = "e79d37ac-7326-4e87-8dff-91ef51c9885d"
license = "Elastic License v2"
name = "Plist Loaded by Launchctl from Unusual Location"
os_list = ["macos"]
reference = ["https://hunt.io/blog/sparkrat-server-detection-macos-activity-and-malicious-connections"]
version = "1.0.8"

query = '''
sequence by process.entity_id with maxspan=10s
[process where event.type == "start" and event.action == "exec" and process.name == "launchctl" and
  process.args == "load"] as event0
[file where event.action == "modification" and file.extension == "plist" and 
 stringcontains~(event0.process.command_line, file.path) and
 not file.path like ("/Library/LaunchAgents/*", 
                     "/Library/LaunchDaemons/*", 
                     "/Users/*/Library/Launch*",
                     "/Users/*/Library/Saved Application State/*", 
                     "/Library/Application Support/*")]
'''

min_endpoint_version = "8.11.0"
optional_actions = []
[[actions]]
action = "kill_process"
field = "process.parent.entity_id"
state = 0

[[threat]]
framework = "MITRE ATT&CK"
[[threat.technique]]
id = "T1543"
name = "Create or Modify System Process"
reference = "https://attack.mitre.org/techniques/T1543/"
[[threat.technique.subtechnique]]
id = "T1543.001"
name = "Launch Agent"
reference = "https://attack.mitre.org/techniques/T1543/001/"

[[threat.technique.subtechnique]]
id = "T1543.004"
name = "Launch Daemon"
reference = "https://attack.mitre.org/techniques/T1543/004/"


[[threat.technique]]
id = "T1547"
name = "Boot or Logon Autostart Execution"
reference = "https://attack.mitre.org/techniques/T1547/"
[[threat.technique.subtechnique]]
id = "T1547.011"
name = "Plist Modification"
reference = "https://attack.mitre.org/techniques/T1547/011/"



[threat.tactic]
id = "TA0003"
name = "Persistence"
reference = "https://attack.mitre.org/tactics/TA0003/"

[internal]
min_endpoint_version = "8.11.0"
